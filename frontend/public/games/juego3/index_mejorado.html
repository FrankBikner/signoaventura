<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signo Aventura - Sistema de Juegos Matem√°ticos</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #87CEEB 0%, #98FB98 50%, #FFE4B5 100%);
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            color: #2F4F4F;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            color: #8B4513;
        }
        
        .header p {
            font-size: 1.2em;
            margin: 5px 0;
            color: #2F4F4F;
        }
        
        #game-container {
            border: 4px solid #8B4513;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
            background: white;
            padding: 15px;
            width: 850px;
            height: 750px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        #game-canvas {
            width: 800px;
            height: 600px;
            border-radius: 15px;
            margin-bottom: 15px;
        }
        
        .game-info {
            text-align: center;
            margin-bottom: 10px;
            color: #2F4F4F;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .btn {
            background: linear-gradient(145deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            min-width: 120px;
        }
        
        .btn:hover {
            background: linear-gradient(145deg, #45a049, #4CAF50);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn.secondary {
            background: linear-gradient(145deg, #2196F3, #1976D2);
        }
        
        .btn.secondary:hover {
            background: linear-gradient(145deg, #1976D2, #2196F3);
        }
        
        .btn.danger {
            background: linear-gradient(145deg, #f44336, #d32f2f);
        }
        
        .btn.danger:hover {
            background: linear-gradient(145deg, #d32f2f, #f44336);
        }
        
        .mode-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .mode-btn {
            padding: 8px 16px;
            font-size: 14px;
            min-width: 100px;
        }
        
        .mode-btn.active {
            background: linear-gradient(145deg, #FF9800, #F57C00);
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.8);
            border-radius: 10px;
            font-size: 14px;
            color: #2F4F4F;
            width: 100%;
            max-width: 800px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #8B4513;
        }
        
        .loading {
            text-align: center;
            color: #8B4513;
            font-size: 18px;
            margin: 20px 0;
        }
        
        .loading::after {
            content: '';
            animation: dots 1.5s steps(5, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% {
                color: rgba(0,0,0,0);
                text-shadow: .25em 0 0 rgba(0,0,0,0),
                            .5em 0 0 rgba(0,0,0,0);
            }
            40% {
                color: #8B4513;
                text-shadow: .25em 0 0 rgba(0,0,0,0),
                            .5em 0 0 rgba(0,0,0,0);
            }
            60% {
                text-shadow: .25em 0 0 #8B4513,
                            .5em 0 0 rgba(0,0,0,0);
            }
            80%, 100% {
                text-shadow: .25em 0 0 #8B4513,
                            .5em 0 0 #8B4513;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üçé Signo Aventura üçé</h1>
        <p>Sistema de Juegos Matem√°ticos para Operadores de Comparaci√≥n</p>
    </div>
    
    <div id="game-container">
        <div id="loading" class="loading">Cargando juego</div>
        <div id="game-canvas" style="display: none;"></div>
        
        <div class="game-info">
            <div id="game-status">¬°Selecciona un modo de juego y comienza a aprender!</div>
        </div>
        
        <div class="stats" id="game-stats" style="display: none;">
            <div class="stat-item">
                <div class="stat-value" id="current-level">1</div>
                <div>Nivel</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="problems-solved">0</div>
                <div>Problemas</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="current-mode">Igualdad</div>
                <div>Modo</div>
            </div>
        </div>
        
        <div class="controls">
            <button id="reset-btn" class="btn">üîÑ Nuevo Problema</button>
            <button id="help-btn" class="btn secondary">‚ùì Ayuda</button>
        </div>
        
        <div class="mode-selector">
            <button id="mode-equality" class="btn mode-btn active">= Igualdad</button>
            <button id="mode-greater" class="btn mode-btn">> Mayor que</button>
            <button id="mode-lesser" class="btn mode-btn">< Menor que</button>
        </div>
    </div>

    <script src="phaser.js"></script>
    <script src="src/scenes/GameScene_mejorado.js"></script>
    <script>
        // Configuraci√≥n global del juego
        window.GAME_CONFIG = {
            // Configuraci√≥n del juego de manzanas
            MAX_APPLES: 6,
            MIN_APPLES: 1,
            TREE_POSITIONS: [
                { x: 150, y: 200 },
                { x: 200, y: 180 },
                { x: 250, y: 190 },
                { x: 180, y: 240 },
                { x: 220, y: 250 },
                { x: 270, y: 230 }
            ],
            
            // Configuraci√≥n de progreso
            GAME_ID: 3,                // ID del juego en la base de datos
            API_BASE_URL: 'http://localhost:8080/api/pcontrolador'
        };

        // Funciones para manejar el progreso
        window.PROGRESS_MANAGER = {
            getCurrentUser: function() {
                const sessionStudentId = localStorage.getItem('sessionStudentId');
                const sessionUser = localStorage.getItem('sessionUser');
                
                if (!sessionStudentId || !sessionUser) {
                    return null;
                }
                
                return {
                    id: parseInt(sessionStudentId),
                    usuario: sessionUser
                };
            },
            
            loadProgress: async function() {
                const user = this.getCurrentUser();
                if (!user) return null;
                
                try {
                    const response = await fetch(`${window.GAME_CONFIG.API_BASE_URL}/progreso/${user.id}/${window.GAME_CONFIG.GAME_ID}`);
                    if (response.ok) {
                        const progreso = await response.json();
                        return progreso;
                    } else if (response.status === 404) {
                        return null;
                    }
                } catch (error) {
                    console.error('Error cargando progreso:', error);
                }
                return null;
            },
            
            saveProgress: async function(puntuacion, tiempoJugado) {
                const user = this.getCurrentUser();
                if (!user) {
                    return false;
                }
                
                const progresoData = {
                    idEstudiante: user.id,
                    idJuego: window.GAME_CONFIG.GAME_ID,
                    puntuacion: puntuacion,
                    fechaIntento: new Date().toISOString(),
                    tiempoJugado: tiempoJugado
                };
                
                try {
                    const response = await fetch(`${window.GAME_CONFIG.API_BASE_URL}/guardarProgreso`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(progresoData)
                    });
                    
                    if (response.ok) {
                        const savedProgress = await response.json();
                        return true;
                    } else {
                        return false;
                    }
                } catch (error) {
                    return false;
                }
            }
        };

        // Variables globales
        let game = null;
        let gameScene = null;
        let problemsSolved = 0;
        let currentMode = 'equality';

        // Inicializar el juego
        function initGame() {
            try {
                // Configuraci√≥n principal del juego Phaser mejorada
                const config = {
                    type: Phaser.AUTO,
                    width: 800,
                    height: 600,
                    parent: 'game-canvas',
                    backgroundColor: '#87CEEB',
                    physics: {
                        default: 'arcade',
                        arcade: {
                            gravity: { y: 0 },
                            debug: false
                        }
                    },
                    scene: [GameScene],
                    scale: {
                        mode: Phaser.Scale.FIT,
                        autoCenter: Phaser.Scale.CENTER_BOTH
                    }
                };

                game = new Phaser.Game(config);
                
                game.events.on('ready', () => {
                    gameScene = game.scene.getScene('GameScene');
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('game-canvas').style.display = 'block';
                    document.getElementById('game-stats').style.display = 'flex';
                    updateGameStatus('¬°Juego cargado! Selecciona un modo y comienza a jugar.');
                    console.log('üéÆ Juego de Manzanas Phaser mejorado iniciado correctamente');
                });
                
            } catch (error) {
                console.error('Error al inicializar el juego:', error);
                document.getElementById('loading').textContent = 'Error al cargar el juego. Por favor, recarga la p√°gina.';
            }
        }

        // Funciones de utilidad
        function updateGameStatus(message) {
            document.getElementById('game-status').textContent = message;
        }

        function updateStats() {
            if (gameScene) {
                document.getElementById('current-level').textContent = gameScene.gameState.currentLevel;
                document.getElementById('problems-solved').textContent = problemsSolved;
                
                const modeNames = {
                    'equality': 'Igualdad',
                    'greater': 'Mayor que',
                    'lesser': 'Menor que'
                };
                document.getElementById('current-mode').textContent = modeNames[currentMode];
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const resetBtn = document.getElementById('reset-btn');
            const helpBtn = document.getElementById('help-btn');
            const modeButtons = {
                equality: document.getElementById('mode-equality'),
                greater: document.getElementById('mode-greater'),
                lesser: document.getElementById('mode-lesser')
            };
            
            // Bot√≥n de reinicio
            resetBtn.addEventListener('click', () => {
                if (gameScene) {
                    gameScene.resetGame();
                    updateGameStatus('¬°Nuevo problema generado! Sigue las instrucciones en pantalla.');
                    updateStats();
                }
            });
            
            // Bot√≥n de ayuda
            helpBtn.addEventListener('click', () => {
                const helpMessages = {
                    equality: `üçé MODO IGUALDAD (=)

1. Observa el n√∫mero objetivo en el panel de informaci√≥n
2. Arrastra EXACTAMENTE esa cantidad de manzanas del √°rbol
3. Suelta las manzanas en la zona de recolecci√≥n (caja marr√≥n)
4. ¬°No recolectes m√°s ni menos de las necesarias!

üéØ OBJETIVO: Aprender el concepto de igualdad matem√°tica
Ejemplo: Si el objetivo es 3, debes recolectar exactamente 3 manzanas.`,

                    greater: `üçé MODO MAYOR QUE (>)

1. Observa el n√∫mero objetivo en el panel de informaci√≥n
2. Arrastra M√ÅS manzanas de las que indica el objetivo
3. Suelta las manzanas en la zona de recolecci√≥n
4. ¬°Aseg√∫rate de recolectar m√°s de la cantidad indicada!

üéØ OBJETIVO: Aprender el concepto "mayor que"
Ejemplo: Si el objetivo es 3, debes recolectar 4, 5 o 6 manzanas.`,

                    lesser: `üçé MODO MENOR QUE (<)

1. Observa el n√∫mero objetivo en el panel de informaci√≥n
2. Arrastra MENOS manzanas de las que indica el objetivo
3. Suelta las manzanas en la zona de recolecci√≥n
4. ¬°Aseg√∫rate de recolectar menos de la cantidad indicada!

üéØ OBJETIVO: Aprender el concepto "menor que"
Ejemplo: Si el objetivo es 4, debes recolectar 1, 2 o 3 manzanas.`
                };
                
                alert(helpMessages[currentMode]);
            });
            
            // Botones de modo
            Object.keys(modeButtons).forEach(mode => {
                modeButtons[mode].addEventListener('click', () => {
                    // Actualizar botones activos
                    Object.values(modeButtons).forEach(btn => btn.classList.remove('active'));
                    modeButtons[mode].classList.add('active');
                    
                    // Cambiar modo del juego
                    currentMode = mode;
                    if (gameScene) {
                        gameScene.changeGameMode(mode);
                        updateGameStatus('Modo cambiado. ¬°Nuevo problema generado!');
                        updateStats();
                    }
                });
            });
            
            // Inicializar el juego
            initGame();
            
            console.log('üéÆ Event listeners configurados');
        });

        // Funciones globales para integraci√≥n
        function getGameStats() {
            if (gameScene) {
                return {
                    currentProblem: gameScene.gameState,
                    problemsSolved: problemsSolved,
                    currentMode: currentMode,
                    timestamp: new Date().toISOString()
                };
            }
            return null;
        }

        function setGameDifficulty(minApples, maxApples) {
            if (gameScene) {
                gameScene.setDifficulty(minApples, maxApples);
                updateGameStatus('Dificultad actualizada. ¬°Nuevo problema generado!');
                console.log('‚öôÔ∏è Dificultad actualizada:', { min: minApples, max: maxApples });
            }
        }

        function onProblemSolved() {
            problemsSolved++;
            updateStats();
        }

        // Escuchar eventos del juego
        if (typeof window !== 'undefined') {
            window.addEventListener('phaser-game-complete', onProblemSolved);
        }

        console.log('üçé Juego de Manzanas - Versi√≥n con Progreso cargado');
        console.log('üì± Sistema de Juegos Matem√°ticos - Signo Aventura cargado');
    </script>
</body>
</html>

